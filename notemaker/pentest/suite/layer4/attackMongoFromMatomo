#!/bin/bash

echo "----- matomo container to mongo container attack --------"
echo "-------  attempting to connect to mongodb:27017  --------"

mongoPod=$(kubectl get pods -n notemaker | grep mongo  | head -1 | awk '{print $1}')
mongoIP=$(kubectl describe pod -n notemaker $mongoPod | grep IP | awk '{print $2 }')
mongoURL="$mongoIP:27017"
matomoPod=$(kubectl get pods -n web-analytics | grep matomo | head -1 | awk '{print $1}')

result=$(kubectl exec -it $matomoPod -n web-analytics -- sh -c "curl -m 5 $mongoURL" 2>&1 | cut -c 4-56)
printf "%s %s\n" ">>" "$result"

success=$(echo $result | grep -c "MongoDB over HTTP")
[[ "$success" == "1" ]] && echo "!--- LAYER 4 CONTAINER-to-CONTAINER ATTACK SUCCESSFUL ---" && echo && exit 0 
[[ "$success" == "0" ]] && echo "----- LAYER 4 CONTAINER-to-CONTAINER ATTACK FAILED ------" && echo && exit 1



